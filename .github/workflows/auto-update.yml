name: Auto Update and Deploy

# Workflow à¸ªà¸³à¸«à¸£à¸±à¸šà¸­à¸±à¸›à¹€à¸”à¸•à¹à¸¥à¸° deploy à¹€à¸§à¹‡à¸šà¹„à¸‹à¸•à¹Œà¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´
# à¸£à¸­à¸‡à¸£à¸±à¸šà¸à¸²à¸£à¹€à¸£à¸µà¸¢à¸à¹ƒà¸Šà¹‰à¸”à¹‰à¸§à¸¢ manual trigger à¹à¸¥à¸° schedule

on:
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild all assets'
        required: false
        default: false
        type: boolean
      clear_cache:
        description: 'Clear GitHub Actions cache'
        required: false
        default: false
        type: boolean
  
  # à¹€à¸£à¸µà¸¢à¸à¹ƒà¸Šà¹‰à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¹€à¸¡à¸·à¹ˆà¸­à¸¡à¸µà¸à¸²à¸£ push à¹„à¸Ÿà¸¥à¹Œà¸ªà¸³à¸„à¸±à¸
  push:
    branches: [ main ]
    paths:
      - 'css/**'
      - 'js/**'
      - 'pages/**'
      - '*.html'
      - 'images/**'
  
  # à¹€à¸£à¸µà¸¢à¸à¹ƒà¸Šà¹‰à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¸—à¸¸à¸à¸§à¸±à¸™à¹€à¸—à¸µà¹ˆà¸¢à¸‡à¸„à¸·à¸™ (UTC) à¹€à¸à¸·à¹ˆà¸­à¸£à¸µà¹€à¸Ÿà¸£à¸Š cache
  schedule:
    - cron: '0 0 * * *'

jobs:
  auto-update:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pages: write
      id-token: write
      actions: write
      
    concurrency:
      group: "auto-update-${{ github.ref }}"
      cancel-in-progress: true
      
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ—‘ï¸ Clear cache if requested
      if: ${{ inputs.clear_cache == true }}
      run: |
        echo "ğŸ§¹ Clearing GitHub Actions cache..."
        gh cache delete --all || true
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: âš™ï¸ Setup Node.js (if needed)
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: ğŸ”„ Update build timestamp
      run: |
        BUILD_TIME=$(date +%s)
        BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)
        
        echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV
        echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
        echo "ğŸ“… Build time: $BUILD_TIME"
        echo "ğŸ“… Build date: $BUILD_DATE"

    - name: ğŸ”§ Optimize and prepare assets
      run: |
        echo "ğŸš€ Optimizing assets for Green Blue Rest Bangkok..."
        
        # Ensure scripts directory exists
        mkdir -p scripts
        
        # Make sure cache-buster.js has the latest features
        echo "ğŸ”„ Updating cache-buster functionality..."
        
        # Create optimized build info
        cat > build-info.json << EOF
        {
          "buildTime": "$BUILD_TIME",
          "buildDate": "$BUILD_DATE",
          "commit": "$GITHUB_SHA",
          "branch": "$GITHUB_REF_NAME",
          "workflow": "$GITHUB_RUN_ID",
          "triggerEvent": "$GITHUB_EVENT_NAME",
          "version": "auto-$BUILD_TIME"
        }
        EOF
        
        # Add build info to main JavaScript files
        echo "ğŸ“‹ Injecting build info into JavaScript..."
        for js_file in js/*.js; do
          if [[ -f "$js_file" && ! "$js_file" =~ cache-buster ]]; then
            if ! grep -q "BUILD_INFO" "$js_file"; then
              echo "// BUILD_INFO: $BUILD_DATE" >> "$js_file"
            fi
          fi
        done

    - name: ğŸ¨ Process CSS with cache-busting
      run: |
        echo "ğŸ¨ Processing CSS files..."
        
        # Add version info to CSS files
        for css_file in css/*.css; do
          if [[ -f "$css_file" ]]; then
            if ! grep -q "Build:" "$css_file"; then
              echo "/* Build: $BUILD_DATE */" >> "$css_file"
            fi
          fi
        done

    - name: ğŸ–¼ï¸ Optimize images (if tools available)
      run: |
        echo "ğŸ–¼ï¸ Checking image optimization..."
        
        # Count images
        image_count=$(find images -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" -o -name "*.webp" \) 2>/dev/null | wc -l || echo 0)
        echo "ğŸ“Š Found $image_count images"
        
        # Basic image validation
        for img in $(find images -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" \) 2>/dev/null | head -10); do
          if [[ -f "$img" ]]; then
            size=$(stat -f%z "$img" 2>/dev/null || stat -c%s "$img" 2>/dev/null || echo "unknown")
            echo "   ğŸ“ $(basename "$img"): ${size} bytes"
          fi
        done

    - name: ğŸ—ï¸ Build site with enhanced caching
      run: |
        echo "ğŸ—ï¸ Building Green Blue Rest Bangkok website with enhanced features..."
        
        # Copy main.html to index.html for GitHub Pages
        cp main.html index.html
        echo "âœ… Created index.html from main.html"
        
        # Enhanced cache busting - add to all HTML files
        echo "ğŸ”„ Applying advanced cache busting..."
        for html_file in $(find . -maxdepth 2 -name "*.html"); do
          echo "   Processing: $html_file"
          
          # Add cache busting to CSS files
          sed -i.bak "s/\.css\"/\.css?v=$BUILD_TIME\"/g" "$html_file"
          
          # Add cache busting to JS files
          sed -i.bak "s/\.js\"/\.js?v=$BUILD_TIME\"/g" "$html_file"
          
          # Ensure cache-buster script is included
          if ! grep -q "cache-buster.js" "$html_file"; then
            sed -i.bak 's|</head>|    <script src="js/cache-buster.js?v='$BUILD_TIME'"></script>\n</head>|' "$html_file"
          fi
          
          # Clean up backup files
          rm -f "$html_file.bak"
        done
        
        # Create a deployment manifest
        cat > deployment-manifest.json << EOF
        {
          "deployment": {
            "timestamp": "$BUILD_TIME",
            "date": "$BUILD_DATE",
            "version": "auto-$BUILD_TIME",
            "commit": "$GITHUB_SHA",
            "branch": "$GITHUB_REF_NAME",
            "files": {
              "html": $(find . -name "*.html" | wc -l),
              "css": $(find . -name "*.css" | wc -l),
              "js": $(find . -name "*.js" | wc -l),
              "images": $(find . -name "*.jpg" -o -name "*.png" -o -name "*.gif" | wc -l)
            }
          }
        }
        EOF
        
        echo "âœ… Enhanced build completed successfully"

    - name: ğŸ§ª Validate build
      run: |
        echo "ğŸ§ª Validating build output..."
        
        # Check essential files exist
        essential_files=("index.html" "css/style.css" "js/main.js" "js/cache-buster.js")
        for file in "${essential_files[@]}"; do
          if [[ -f "$file" ]]; then
            echo "âœ… $file exists"
          else
            echo "âŒ $file missing"
            exit 1
          fi
        done
        
        # Validate HTML structure
        if grep -q "<title>" index.html; then
          echo "âœ… HTML structure valid"
        else
          echo "âŒ HTML structure invalid"
          exit 1
        fi
        
        echo "ğŸ‰ Build validation passed!"

    - name: ğŸ“Š Generate deployment report
      run: |
        echo "ğŸ“Š Generating deployment report..."
        
        cat > deployment-report.md << EOF
        # ğŸš€ Deployment Report
        
        **Build Date:** $BUILD_DATE
        **Build Time:** $BUILD_TIME
        **Commit:** $GITHUB_SHA
        **Branch:** $GITHUB_REF_NAME
        **Workflow:** $GITHUB_RUN_ID
        
        ## ğŸ“‹ Build Summary
        - âœ… Cache busting applied
        - âœ… Assets optimized
        - âœ… Build validation passed
        
        ## ğŸ“‚ File Counts
        - HTML files: $(find . -name "*.html" | wc -l)
        - CSS files: $(find . -name "*.css" | wc -l)
        - JavaScript files: $(find . -name "*.js" | wc -l)
        - Images: $(find . -name "*.jpg" -o -name "*.png" -o -name "*.gif" | wc -l)
        
        ---
        *Auto-generated by GitHub Actions*
        EOF
        
        echo "ğŸ“‹ Deployment report created"

    - name: ğŸ“¤ Setup Pages
      uses: actions/configure-pages@v4

    - name: ğŸ“¦ Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'

    - name: ğŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: ğŸ¯ Post-deployment validation
      run: |
        echo "ğŸ¯ Running post-deployment validation..."
        
        # Wait a moment for deployment to propagate
        sleep 30
        
        # Test site accessibility
        SITE_URL="https://nattagid.github.io/greenbluerestbangkok"
        
        if curl -sf "$SITE_URL" > /dev/null; then
          echo "âœ… Site is accessible at $SITE_URL"
          
          # Check if cache busting is working
          response=$(curl -s -I "$SITE_URL/css/style.css?v=$BUILD_TIME" || echo "")
          if [[ "$response" == *"200"* ]]; then
            echo "âœ… Cache busting is working"
          else
            echo "âš ï¸ Cache busting may not be working correctly"
          fi
        else
          echo "âš ï¸ Site may not be immediately accessible (this is sometimes normal)"
        fi

    - name: ğŸ“¢ Success notification
      run: |
        echo "ğŸ‰ Auto-update and deployment completed successfully!"
        echo "ğŸŒ Site URL: https://nattagid.github.io/greenbluerestbangkok"
        echo "ğŸ“… Build time: $BUILD_DATE"
        echo "ğŸ”– Version: auto-$BUILD_TIME"
        echo ""
        echo "âœ¨ Features applied:"
        echo "   - âœ… Advanced cache busting"
        echo "   - âœ… Asset optimization" 
        echo "   - âœ… Build validation"
        echo "   - âœ… Deployment verification"